<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <title></title>
</head>

<body>
    <div>BB Message</div>
    <div id="output"></div>
    <div class="btn-bar">
        <button onclick="doConnect()">Connect</button>
        <button onclick="doDisconnect()">Disconnect</button>
    </div>
    <div class="input">
        <input id="txtMsg" type="text" />
        <button id="sendButton" onclick=" doSend()">send Message</button>
    </div>
</body>

</html>

<script src="lib/signalr.js"></script>

<script language="javascript" type="text/javascript">
    var socket;
    var uri = "ws://" + window.location.host + "/ws";
    var output;
    var text = "test echo";

    function write(s) {
        var p = document.createElement("p");
        console.log(s);
        p.innerHTML = s;
        output.appendChild(p);
    }

    const connection = new signalR.HubConnectionBuilder().withUrl("/chat").build();


    // function doConnect() {
    //     if (!socket) {
    //         socket = new WebSocket(uri);
    //     } else if (socket.readyState != 1) {
    //         console.log(socket.readyState);
    //         socket = new WebSocket(uri);
    //     }
    //     socket.onopen = e => {
    //         write("opened " + uri);
    //     };
    //     socket.onclose = e => {
    //         write("closed");
    //     };
    //     socket.onmessage = e => {
    //         write("Received: " + e.data);
    //     };
    //     socket.onerror = function(e) {
    //         write("Error: " + e.data);
    //     };
    // }

    function doDisconnect() {
        socket.close();
    }

    function doSend(txt) {

        var txtMsg = document.querySelector('#txtMsg');
        txt = txtMsg.value;

        write("Sending: " + txt);
        // socket.send(txt);
        connection.invoke("Send", txt)
            .catch(err => console.error(err));
        event.preventDefault();
    }

    function onInit() {
        output = document.getElementById("output");
        //doConnect();
    }

    //window.onload = onInit;
    $(document).ready(() => {
        onInit();
    })
</script>
<script language="javascript" type="text/javascript">
    connection.on("ReceiveMessage", (user, message) => {
        const encodedMsg = user + " says " + message;
        const li = document.createElement("li");
        li.textContent = encodedMsg;
        // document.getElementById("messagesList").appendChild(li);
        write(encodedMsg);
    });

    // document.getElementById("sendButton").addEventListener("click", event => {
    //     const user = document.getElementById("userInput").value;
    //     const message = document.getElementById("messageInput").value;
    //     connection.invoke("SendMessage", user, message).catch(err => console.error(err.toString()));
    //     event.preventDefault();
    // });

    connection.start().catch(err => console.error(err.toString()));
</script>